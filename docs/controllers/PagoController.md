# üí≥ PagoController - Documentaci√≥n Completa

## üìã Informaci√≥n General

**Archivo**: `app/Http/Controllers/PagoController.php`  
**Prop√≥sito**: Gesti√≥n integral de pagos, cuotas y facturaci√≥n de pacientes  
**Dependencias**: Laravel Framework, Modelos Pago, DetallePago, CuotaPago, Paciente, Usuario  
**Versi√≥n**: 2.1  
**√öltima actualizaci√≥n**: 10 de Septiembre 2025

## üéØ Responsabilidades del Controlador

El PagoController es el n√∫cleo del sistema financiero del consultorio, responsable de:

1. **Registro de Pagos** - Creaci√≥n y gesti√≥n de pagos √∫nicos y en cuotas
2. **Gesti√≥n de Cuotas** - Administraci√≥n de pagos parciales y cuotas variables/fijas
3. **Facturaci√≥n** - Generaci√≥n y seguimiento de facturas y recibos
4. **Auditor√≠a Financiera** - Logging y trazabilidad de todas las operaciones
5. **Integraci√≥n con Pacientes** - Relaci√≥n directa con expedientes cl√≠nicos
6. **Seguridad y Validaci√≥n** - Control de acceso y validaciones estrictas

## üèóÔ∏è Arquitectura y Dise√±o

### Modelo de Datos Principal
```php
// Estructura del modelo Pago
[
    'id' => 'bigint auto_increment',
    'paciente_id' => 'bigint FOREIGN KEY REFERENCES pacientes(id)',
    'usuario_id' => 'bigint FOREIGN KEY REFERENCES usuarios(id)',
    'fecha_pago' => 'date NOT NULL',
    'monto_total' => 'decimal(10,2) NOT NULL',
    'monto_pagado' => 'decimal(10,2) DEFAULT 0',
    'saldo_restante' => 'decimal(10,2) DEFAULT 0',
    'descripcion' => 'varchar(500) NOT NULL',
    'modalidad_pago' => "enum('pago_unico','cuotas_fijas','cuotas_variables')",
    'total_cuotas' => 'integer NULLABLE',
    'estado_pago' => "enum('pendiente','pagado_completo','en_cuotas') DEFAULT 'pendiente'",
    'observaciones' => 'text NULLABLE',
    'created_at' => 'timestamp',
    'updated_at' => 'timestamp'
]
```

### Modelos Relacionados
- **DetallePago**: Registro de cada abono o cuota
- **CuotaPago**: Cuotas fijas o variables asociadas a un pago
- **Paciente**: Relaci√≥n belongsTo
- **Usuario**: Relaci√≥n belongsTo (dentista o recepcionista)

### Patrones de Dise√±o Implementados
- **Strategy Pattern**: Modalidades de pago (√∫nico, cuotas fijas, cuotas variables)
- **Observer Pattern**: Auditor√≠a autom√°tica de pagos
- **Repository Pattern**: Acceso estructurado a datos financieros

## üìö M√©todos Documentados

### 1. `getPacientes()`

#### üéØ Prop√≥sito
Obtener lista de pacientes para el registro de pagos, filtrados por usuario si es necesario.

#### üì• Par√°metros de Entrada
Ninguno (GET simple)

#### üîç Proceso de Ejecuci√≥n
1. **Intento de obtener usuario autenticado**: Si no hay sesi√≥n, devuelve todos los pacientes
2. **Consulta optimizada**: SELECT id, nombre_completo
3. **Ordenamiento alfab√©tico**
4. **Respuesta JSON**: Lista de pacientes

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "pacientes": [
        { "id": 1, "nombre_completo": "Mar√≠a Garc√≠a L√≥pez" },
        { "id": 2, "nombre_completo": "Carlos Mendoza Ruiz" }
    ]
}
```

#### ‚ùå Respuesta de Error
```json
{
    "success": false,
    "message": "Error al cargar pacientes: ..."
}
```

---

### 2. `registrarPago(Request $request)`

#### üéØ Prop√≥sito
Registrar un nuevo pago para un paciente, soportando pago √∫nico, cuotas fijas y cuotas variables.

#### üì• Par√°metros de Entrada
```php
[
    'paciente_id' => 'required|exists:pacientes,id',
    'monto_total' => 'required|numeric|min:0.01',
    'descripcion' => 'required|string|max:500',
    'modalidad_pago' => 'required|in:pago_unico,cuotas_fijas,cuotas_variables',
    'total_cuotas' => 'nullable|integer|min:1|max:60',
    'fecha_pago' => 'required|date',
    'observaciones' => 'nullable|string|max:1000'
]
```

#### üîç Proceso de Ejecuci√≥n
1. **Validaci√≥n de entrada**: Reglas estrictas para cada campo
2. **Transacci√≥n at√≥mica**: beginTransaction para consistencia
3. **Obtenci√≥n de usuario**: Sesi√≥n activa o fallback a dentista
4. **Creaci√≥n de pago**: Inserta registro principal
5. **Configuraci√≥n seg√∫n modalidad**:
   - Pago √∫nico: marca como pagado completo
   - Cuotas fijas: crea cuotas autom√°ticas
   - Cuotas variables: saldo pendiente
6. **Registro de detalle**: Crea DetallePago para pago √∫nico
7. **Creaci√≥n de cuotas**: Si corresponde, crea CuotaPago
8. **Commit de transacci√≥n**: Guarda todos los cambios
9. **Respuesta estructurada**: Retorna pago y paciente

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "message": "Pago registrado exitosamente",
    "pago": {
        "id": 123,
        "paciente_id": 1,
        "usuario_id": 2,
        "fecha_pago": "2025-09-10",
        "monto_total": 1500.00,
        "monto_pagado": 0.00,
        "saldo_restante": 1500.00,
        "descripcion": "Tratamiento de ortodoncia",
        "modalidad_pago": "cuotas_fijas",
        "total_cuotas": 6,
        "estado_pago": "pendiente",
        "observaciones": null,
        "created_at": "2025-09-10T15:00:00.000000Z",
        "updated_at": "2025-09-10T15:00:00.000000Z",
        "paciente": {
            "id": 1,
            "nombre_completo": "Mar√≠a Garc√≠a L√≥pez"
        }
    }
}
```

#### ‚ùå Respuestas de Error
```json
{
    "success": false,
    "message": "Error al registrar pago: ..."
}
```

---

### 3. `crearCuotasFijas(Pago $pago, $totalCuotas)` (Privado)

#### üéØ Prop√≥sito
Crear autom√°ticamente cuotas fijas para un pago, distribuyendo el monto total equitativamente.

#### üì• Par√°metros de Entrada
- `$pago`: Instancia de Pago reci√©n creado
- `$totalCuotas`: N√∫mero de cuotas a crear

#### üîç Proceso de Ejecuci√≥n
1. **C√°lculo de monto por cuota**: Divide monto_total entre total_cuotas
2. **Creaci√≥n de cuotas**: Inserta cada cuota en CuotaPago
3. **Asociaci√≥n con pago**: Relaciona cada cuota con el pago principal
4. **Fechas de vencimiento**: Calcula fechas mensuales sucesivas

#### üì§ Ejemplo de Cuotas Generadas
```json
[
    { "nro_cuota": 1, "monto": 250.00, "fecha_vencimiento": "2025-10-10" },
    { "nro_cuota": 2, "monto": 250.00, "fecha_vencimiento": "2025-11-10" },
    ...
]
```

---

### 4. `getUsuarioAutenticado()` (Privado)

#### üéØ Prop√≥sito
Obtener el usuario autenticado desde la sesi√≥n, o lanzar excepci√≥n si no existe.

#### üîç Proceso de Ejecuci√≥n
1. **Verifica existencia de usuario_id en sesi√≥n**
2. **Consulta en base de datos**
3. **Lanza excepci√≥n si no existe**

#### üì§ Ejemplo de Uso
```php
$usuario = $this->getUsuarioAutenticado();
```

---

## üîí Caracter√≠sticas de Seguridad

### Validaci√≥n de Entrada
```php
// Reglas estrictas
'paciente_id' => 'required|exists:pacientes,id',
'monto_total' => 'required|numeric|min:0.01',
'descripcion' => 'required|string|max:500',
'modalidad_pago' => 'required|in:pago_unico,cuotas_fijas,cuotas_variables',
'total_cuotas' => 'nullable|integer|min:1|max:60',
'fecha_pago' => 'required|date',
'observaciones' => 'nullable|string|max:1000'
```

### Transacciones At√≥micas
- **beginTransaction/commit/rollBack**: Garantiza consistencia de datos
- **Rollback autom√°tico** en caso de error

### Auditor√≠a Financiera
- **Logging de todas las operaciones**
- **Registro de usuario responsable**
- **Trazabilidad de cada pago y cuota**

### Control de Acceso
- **Verificaci√≥n de sesi√≥n** para registrar pagos
- **Fallback seguro** a dentista si no hay sesi√≥n
- **Permisos por rol** (futuro)

## üìä Casos de Uso Empresariales

### 1. Registro de Pago √önico
```php
// Flujo t√≠pico
1. Recepcionista selecciona paciente
2. Ingresa monto y descripci√≥n
3. Selecciona modalidad "pago √∫nico"
4. Sistema registra pago y lo marca como pagado completo
5. Se genera recibo y se asocia al expediente
```

### 2. Registro de Pago en Cuotas Fijas
```php
// Flujo t√≠pico
1. Recepcionista selecciona paciente
2. Ingresa monto total y n√∫mero de cuotas
3. Selecciona modalidad "cuotas fijas"
4. Sistema crea pago y genera cuotas autom√°ticas
5. Se imprime cronograma de pagos
6. Cada cuota se puede abonar individualmente
```

### 3. Registro de Pago en Cuotas Variables
```php
// Flujo t√≠pico
1. Recepcionista selecciona paciente
2. Ingresa monto total
3. Selecciona modalidad "cuotas variables"
4. Sistema crea pago con saldo pendiente
5. Se registran abonos parciales seg√∫n acuerdo
```

## üß™ Casos de Prueba

### Pruebas de Registro de Pago
```php
// Test: Pago √∫nico exitoso
$response = $this->post('/api/pagos', [
    'paciente_id' => 1,
    'monto_total' => 1000,
    'descripcion' => 'Tratamiento de caries',
    'modalidad_pago' => 'pago_unico',
    'fecha_pago' => '2025-09-10'
]);
$response->assertStatus(200);
$response->assertJsonPath('success', true);

// Test: Pago en cuotas fijas
$response = $this->post('/api/pagos', [
    'paciente_id' => 1,
    'monto_total' => 1200,
    'descripcion' => 'Ortodoncia',
    'modalidad_pago' => 'cuotas_fijas',
    'total_cuotas' => 6,
    'fecha_pago' => '2025-09-10'
]);
$response->assertStatus(200);
$response->assertJsonPath('pago.total_cuotas', 6);

// Test: Validaci√≥n de monto negativo
$response = $this->post('/api/pagos', [
    'paciente_id' => 1,
    'monto_total' => -100,
    'descripcion' => 'Error',
    'modalidad_pago' => 'pago_unico',
    'fecha_pago' => '2025-09-10'
]);
$response->assertStatus(422);
```

## üìà M√©tricas y Rendimiento

### Tiempo de Respuesta T√≠pico
- Registro de pago √∫nico: ~120ms
- Registro de pago en cuotas: ~180ms
- Consulta de pacientes: ~60ms

### Optimizaciones de Base de Datos
- √çndices en paciente_id, usuario_id, fecha_pago
- Transacciones para operaciones cr√≠ticas
- Carga diferida de relaciones

## üö® Manejo de Errores

### Categor√≠as de Errores
1. **Errores de Validaci√≥n** (422)
   - Campos requeridos faltantes
   - Formato de monto inv√°lido
   - Modalidad de pago no soportada
2. **Errores de Autenticaci√≥n** (401)
   - Usuario no autenticado
   - Usuario no encontrado
3. **Errores de Negocio** (400)
   - No hay dentistas disponibles
   - N√∫mero de cuotas fuera de rango
4. **Errores del Servidor** (500)
   - Excepciones no controladas
   - Errores de base de datos

### Logging de Errores
- Todos los errores se registran con contexto y stack trace
- Mensajes claros para debugging y auditor√≠a

## üîß Configuraci√≥n y Dependencias

### Variables de Entorno
```env
# Configuraci√≥n de pagos
PAGO_MONEDA=ARS
PAGO_MAX_CUOTAS=60
PAGO_MIN_MONTO=0.01
PAGO_AUDIT_ENABLED=true
```

### Middlewares Relacionados
- `auth` - Requiere autenticaci√≥n para registrar pagos
- `throttle:30,1` - Rate limiting para evitar abuso

## üîÆ Mejoras Futuras

### Versi√≥n 2.2 (Q4 2025)
- Integraci√≥n con pasarelas de pago (MercadoPago, Stripe)
- Facturaci√≥n electr√≥nica autom√°tica
- Notificaciones de vencimiento de cuotas
- Dashboard financiero en tiempo real
- Exportaci√≥n de reportes a Excel/PDF

### Versi√≥n 2.3 (Q1 2026)
- Integraci√≥n con sistemas contables externos
- API REST para pagos de terceros
- Portal de autogesti√≥n de pagos para pacientes
- Machine learning para predicci√≥n de morosidad

## üìö Est√°ndares y Compliance
- **Normas contables locales**
- **Ley de Protecci√≥n de Datos Personales**
- **ISO 27001** para seguridad de informaci√≥n financiera
- **PCI DSS** para manejo de tarjetas (futuro)

---

**Autor**: Sistema DentalSync  
**Fecha de creaci√≥n**: 10 de Septiembre 2025  
**Versi√≥n del documento**: 1.0  
**Estado**: ‚úÖ Completo y actualizado

> üí≥ **Nota**: Este controlador maneja informaci√≥n financiera cr√≠tica. Toda modificaci√≥n debe ser revisada por el √°rea contable y cumplir con las regulaciones fiscales y de protecci√≥n de datos vigentes.
