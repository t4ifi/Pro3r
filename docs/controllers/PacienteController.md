# üë®‚Äç‚öïÔ∏è PacienteController - Documentaci√≥n Completa

## üìã Informaci√≥n General

**Archivo**: `app/Http/Controllers/PacienteController.php`  
**Prop√≥sito**: Gesti√≥n integral de pacientes del consultorio dental  
**Dependencias**: Laravel Framework, Base de datos MySQL, Validaciones personalizadas  
**Versi√≥n**: 2.1  
**√öltima actualizaci√≥n**: 10 de Septiembre 2025

## üéØ Responsabilidades del Controlador

El PacienteController es el coraz√≥n del sistema de gesti√≥n de pacientes, responsable de:

1. **CRUD Completo** - Crear, leer, actualizar y eliminar pacientes
2. **Validaci√≥n de Datos** - Verificaci√≥n exhaustiva de informaci√≥n m√©dica
3. **Gesti√≥n de Historiales** - Mantenimiento de registros m√©dicos
4. **B√∫squeda y Filtrado** - Localizaci√≥n r√°pida de pacientes
5. **Auditor√≠a** - Tracking completo de cambios y accesos
6. **Integraci√≥n con Citas** - Vinculaci√≥n con sistema de appointments

## üèóÔ∏è Arquitectura y Dise√±o

### Modelo de Datos
```php
// Estructura del modelo Paciente
[
    'id' => 'bigint auto_increment',
    'nombre_completo' => 'varchar(255) NOT NULL',
    'telefono' => 'varchar(20) NULLABLE',
    'fecha_nacimiento' => 'date NULLABLE',
    'motivo_consulta' => 'text NULLABLE',
    'alergias' => 'text NULLABLE',
    'observaciones' => 'text NULLABLE',
    'ultima_visita' => 'date NULLABLE',
    'created_at' => 'timestamp',
    'updated_at' => 'timestamp'
]
```

### Relaciones con Otras Entidades
```php
// Relaciones del modelo
Paciente hasMany Citas
Paciente hasMany Tratamientos  
Paciente hasMany Pagos
Paciente hasMany HistorialMedico
```

### Patrones de Dise√±o Implementados
- **Repository Pattern**: Acceso estructurado a datos
- **Validator Pattern**: Validaciones centralizadas y reutilizables
- **Observer Pattern**: Eventos de auditor√≠a autom√°ticos
- **Factory Pattern**: Creaci√≥n controlada de instancias

## üìö M√©todos Documentados

### 1. `index(Request $request)`

#### üéØ Prop√≥sito
Obtener lista paginada de todos los pacientes con capacidades de b√∫squeda y filtrado.

#### üì• Par√°metros de Entrada
```php
// Query parameters opcionales
[
    'search' => 'string',           // B√∫squeda por nombre o tel√©fono
    'page' => 'integer',            // N√∫mero de p√°gina (default: 1)
    'per_page' => 'integer',        // Elementos por p√°gina (default: 15)
    'sort_by' => 'string',          // Campo de ordenamiento
    'sort_order' => 'asc|desc',     // Direcci√≥n del ordenamiento
    'fecha_desde' => 'date',        // Filtro de fecha desde
    'fecha_hasta' => 'date'         // Filtro de fecha hasta
]
```

#### üîç Proceso de Ejecuci√≥n
1. **Logging de acceso**: Registra consulta con detalles del usuario
2. **Construcci√≥n de query**: Aplica filtros y b√∫squedas solicitados
3. **Paginaci√≥n**: Configura l√≠mites y offset seg√∫n par√°metros
4. **Ordenamiento**: Aplica sort seg√∫n criterios especificados
5. **Ejecuci√≥n**: Obtiene datos de la base de datos
6. **Formateo**: Estructura respuesta para el frontend
7. **Logging de resultado**: Registra cantidad de resultados obtenidos

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "nombre_completo": "Mar√≠a Garc√≠a L√≥pez",
            "telefono": "+1234567890",
            "fecha_nacimiento": "1985-03-15",
            "motivo_consulta": "Limpieza dental rutinaria",
            "alergias": "Penicilina",
            "observaciones": "Paciente colaborativo",
            "ultima_visita": "2025-09-01",
            "created_at": "2025-01-15T09:00:00.000000Z",
            "updated_at": "2025-09-01T14:30:00.000000Z"
        }
    ],
    "pagination": {
        "current_page": 1,
        "total_pages": 25,
        "total_items": 372,
        "per_page": 15,
        "from": 1,
        "to": 15
    },
    "filters_applied": {
        "search": "Garc√≠a",
        "sort_by": "nombre_completo",
        "sort_order": "asc"
    }
}
```

#### üõ°Ô∏è Validaciones y Seguridad
- **Sanitizaci√≥n de entrada**: Limpia par√°metros de b√∫squeda
- **L√≠mites de paginaci√≥n**: M√°ximo 100 elementos por p√°gina
- **Escape SQL**: Prevenci√≥n de inyecci√≥n SQL
- **Rate limiting**: M√°ximo 60 consultas por minuto por usuario

---

### 2. `store(Request $request)`

#### üéØ Prop√≥sito
Crear un nuevo paciente en el sistema con validaci√≥n exhaustiva de datos m√©dicos.

#### üì• Par√°metros de Entrada
```php
// Campos requeridos y opcionales
[
    'nombre_completo' => 'required|string|max:255|regex:/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/',
    'telefono' => 'required|string|max:20|regex:/^[\+]?[0-9\s\-\(\)]+$/',
    'fecha_nacimiento' => 'nullable|date|before:today',
    'motivo_consulta' => 'required|string|max:1000',
    'alergias' => 'nullable|string|max:1000',
    'observaciones' => 'nullable|string|max:1000'
]
```

#### üîç Validaciones Detalladas

##### Nombre Completo
```php
// Reglas aplicadas
'required'           // Campo obligatorio
'string'             // Debe ser texto
'max:255'            // M√°ximo 255 caracteres
'regex:/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/'  // Solo letras y espacios (incluye acentos)

// Ejemplos v√°lidos
"Mar√≠a Garc√≠a L√≥pez"
"Jos√© Luis Rodr√≠guez"
"Ana Sof√≠a Mart√≠nez"

// Ejemplos inv√°lidos
"Juan123"            // Contiene n√∫meros
"Mar√≠a@Garc√≠a"       // Contiene s√≠mbolos
""                   // Campo vac√≠o
```

##### Tel√©fono
```php
// Reglas aplicadas
'required'           // Campo obligatorio
'string'             // Debe ser texto
'max:20'             // M√°ximo 20 caracteres
'regex:/^[\+]?[0-9\s\-\(\)]+$/'  // Formato de tel√©fono v√°lido

// Ejemplos v√°lidos
"+1234567890"
"(555) 123-4567"
"555-123-4567"
"555 123 4567"

// Ejemplos inv√°lidos
"telefono123"        // Contiene letras
"123"                // Muy corto
"+123-456-789-012-345"  // Muy largo
```

##### Fecha de Nacimiento
```php
// Reglas aplicadas
'nullable'           // Campo opcional
'date'               // Debe ser fecha v√°lida
'before:today'       // Debe ser anterior a hoy

// Ejemplos v√°lidos
"1985-03-15"
"1990-12-25"
null                 // Permitido como opcional

// Ejemplos inv√°lidos
"2025-12-31"         // Fecha futura
"invalid-date"       // Formato inv√°lido
"31/12/1985"         // Formato incorrecto
```

#### üîç Proceso de Ejecuci√≥n
1. **Logging de inicio**: Registra intento de creaci√≥n con datos de entrada
2. **Validaci√≥n de entrada**: Aplica todas las reglas definidas
3. **Verificaci√≥n de duplicados**: Chequea si ya existe paciente similar
4. **Sanitizaci√≥n de datos**: Limpia y formatea informaci√≥n
5. **Creaci√≥n en BD**: Inserta nuevo registro con timestamp
6. **Auditor√≠a**: Registra creaci√≥n para tracking
7. **Respuesta**: Retorna paciente creado con ID asignado

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "message": "Paciente creado exitosamente",
    "data": {
        "id": 373,
        "nombre_completo": "Carlos Eduardo Mendoza",
        "telefono": "+5491123456789",
        "fecha_nacimiento": "1978-07-22",
        "motivo_consulta": "Dolor en muela del juicio",
        "alergias": "Ninguna conocida",
        "observaciones": "Primera visita al consultorio",
        "ultima_visita": null,
        "created_at": "2025-09-10T15:45:30.000000Z",
        "updated_at": "2025-09-10T15:45:30.000000Z"
    }
}
```

#### ‚ùå Respuestas de Error
```json
// Error de validaci√≥n
{
    "success": false,
    "message": "Los datos proporcionados no son v√°lidos",
    "errors": {
        "nombre_completo": ["El nombre solo puede contener letras y espacios"],
        "telefono": ["El formato del tel√©fono no es v√°lido"],
        "fecha_nacimiento": ["La fecha de nacimiento debe ser anterior a hoy"]
    }
}

// Error de duplicado
{
    "success": false,
    "message": "Ya existe un paciente con informaci√≥n similar",
    "similar_patient": {
        "id": 45,
        "nombre_completo": "Carlos Mendoza",
        "telefono": "+5491123456789"
    }
}
```

---

### 3. `show($id)`

#### üéØ Prop√≥sito
Obtener informaci√≥n completa de un paciente espec√≠fico incluyendo su historial m√©dico.

#### üì• Par√°metros de Entrada
```php
$id  // Integer: ID √∫nico del paciente
```

#### üîç Proceso de Ejecuci√≥n
1. **Validaci√≥n de ID**: Verifica que sea num√©rico y v√°lido
2. **Logging de acceso**: Registra consulta de datos espec√≠ficos
3. **B√∫squeda en BD**: Localiza paciente por ID
4. **Verificaci√≥n de existencia**: Confirma que el paciente existe
5. **Carga de relaciones**: Incluye citas, tratamientos y pagos relacionados
6. **Formateo completo**: Estructura respuesta con datos relacionados
7. **Auditor√≠a**: Registra acceso a informaci√≥n m√©dica

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "data": {
        "id": 1,
        "nombre_completo": "Mar√≠a Garc√≠a L√≥pez",
        "telefono": "+1234567890",
        "fecha_nacimiento": "1985-03-15",
        "edad": 40,
        "motivo_consulta": "Limpieza dental rutinaria",
        "alergias": "Penicilina",
        "observaciones": "Paciente colaborativo, historial de gingivitis",
        "ultima_visita": "2025-09-01",
        "created_at": "2025-01-15T09:00:00.000000Z",
        "updated_at": "2025-09-01T14:30:00.000000Z",
        "estadisticas": {
            "total_citas": 12,
            "citas_completadas": 10,
            "citas_canceladas": 2,
            "total_tratamientos": 5,
            "total_pagado": 1250.50,
            "saldo_pendiente": 150.00
        },
        "ultima_cita": {
            "id": 45,
            "fecha": "2025-09-01",
            "motivo": "Control post-tratamiento",
            "estado": "atendida"
        },
        "proxima_cita": {
            "id": 46,
            "fecha": "2025-09-20",
            "motivo": "Limpieza programada",
            "estado": "confirmada"
        }
    }
}
```

#### ‚ùå Respuesta de Error
```json
{
    "success": false,
    "message": "Paciente no encontrado",
    "error_code": "PATIENT_NOT_FOUND"
}
```

---

### 4. `update(Request $request, $id)`

#### üéØ Prop√≥sito
Actualizar informaci√≥n de un paciente existente con validaci√≥n y auditor√≠a completa.

#### üì• Par√°metros de Entrada
```php
$id         // Integer: ID del paciente a actualizar
$request    // Array con campos a actualizar (mismas validaciones que store)
```

#### üîç Proceso de Ejecuci√≥n Detallado
1. **Logging de inicio**: Registra intento de actualizaci√≥n con datos
2. **Validaci√≥n de ID**: Verifica que sea num√©rico v√°lido
3. **Verificaci√≥n de existencia**: Confirma que el paciente existe
4. **Backup de datos**: Guarda estado anterior para auditor√≠a
5. **Validaci√≥n de entrada**: Aplica reglas de validaci√≥n espec√≠ficas
6. **Detecci√≥n de cambios**: Compara datos nuevos vs existentes
7. **Actualizaci√≥n selectiva**: Solo modifica campos que cambiaron
8. **Auditor√≠a de cambios**: Registra qu√© cambi√≥, cu√°ndo y qui√©n
9. **Respuesta**: Retorna datos actualizados

#### üîç Validaciones Espec√≠ficas para Update
```php
// Reglas adaptadas para actualizaci√≥n
[
    'nombre_completo' => 'sometimes|string|max:255|regex:/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/',
    'telefono' => 'sometimes|string|max:20|regex:/^[\+]?[0-9\s\-\(\)]+$/',
    'fecha_nacimiento' => 'sometimes|nullable|date|before:today',
    'motivo_consulta' => 'sometimes|string|max:1000',
    'alergias' => 'sometimes|nullable|string|max:1000',
    'observaciones' => 'sometimes|nullable|string|max:1000'
]
```

#### üìä Auditor√≠a de Cambios
```php
// Registro detallado de modificaciones
[
    'paciente_id' => 1,
    'usuario_modificador' => 'Dr. Juan P√©rez',
    'timestamp' => '2025-09-10 15:45:30',
    'cambios' => [
        'telefono' => [
            'anterior' => '+1234567890',
            'nuevo' => '+1234567899'
        ],
        'observaciones' => [
            'anterior' => 'Paciente colaborativo',
            'nuevo' => 'Paciente colaborativo, al√©rgico a penicilina'
        ]
    ],
    'razon' => 'Actualizaci√≥n de informaci√≥n de contacto'
]
```

#### üì§ Respuesta Exitosa
```json
{
    "success": true,
    "message": "Paciente actualizado exitosamente",
    "data": {
        "id": 1,
        "nombre_completo": "Mar√≠a Garc√≠a L√≥pez",
        "telefono": "+1234567899",
        "fecha_nacimiento": "1985-03-15",
        "motivo_consulta": "Limpieza dental rutinaria",
        "alergias": "Penicilina",
        "observaciones": "Paciente colaborativo, al√©rgico a penicilina",
        "ultima_visita": "2025-09-01",
        "updated_at": "2025-09-10T15:45:30.000000Z"
    },
    "cambios_realizados": [
        "telefono",
        "observaciones"
    ]
}
```

---

### 5. `destroy($id)` (M√©todo No Implementado - Por Seguridad)

#### üéØ Decisi√≥n de Dise√±o
Por razones de seguridad y regulaciones m√©dicas, NO se implementa eliminaci√≥n f√≠sica de pacientes.

#### üîí Alternativas Implementadas
```php
// Soft Delete (recomendado)
'deleted_at' => 'timestamp nullable'

// Archivado
'archived' => 'boolean default false'
'archived_at' => 'timestamp nullable'
'archived_by' => 'bigint foreign key'

// Estados
'status' => 'enum: active, inactive, archived'
```

#### üìã Razones de No Implementaci√≥n
1. **Regulaciones m√©dicas**: Los historiales deben conservarse
2. **Auditor√≠a legal**: Trazabilidad requerida por ley
3. **Integridad referencial**: Citas y tratamientos relacionados
4. **Recuperaci√≥n de datos**: Posibilidad de reactivar pacientes

## üîí Caracter√≠sticas de Seguridad

### Validaci√≥n de Entrada
```php
// Regex patterns utilizados
'nombre_completo' => '/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/'     // Solo letras y espacios
'telefono' => '/^[\+]?[0-9\s\-\(\)]+$/'                  // Formato telef√≥nico
'motivo_consulta' => '/^[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\.,\-_]+$/'  // Texto m√©dico seguro
```

### Sanitizaci√≥n de Datos
```php
// Procesos autom√°ticos
trim()              // Elimina espacios en blanco
strip_tags()        // Remueve HTML/PHP tags
htmlspecialchars()  // Escapa caracteres especiales
preg_replace()      // Limpia caracteres no permitidos
```

### Rate Limiting
```php
// L√≠mites por usuario
'index' => '60 requests per minute',
'store' => '10 requests per minute',
'update' => '20 requests per minute',
'show' => '100 requests per minute'
```

### Logging de Auditor√≠a
```php
// Eventos registrados
- Creaci√≥n de pacientes
- Actualizaciones de informaci√≥n
- Acceso a datos sensibles
- Intentos de acceso no autorizado
- Errores de validaci√≥n
- B√∫squedas realizadas
```

## üìä Casos de Uso Principales

### 1. Registro de Nuevo Paciente
```php
// Flujo t√≠pico
1. Recepcionista recibe paciente nuevo
2. Ingresa datos b√°sicos en formulario
3. Sistema valida informaci√≥n
4. Se crea registro con ID √∫nico
5. Se programa primera cita
6. Se genera historia cl√≠nica
```

### 2. B√∫squeda de Paciente Existente
```php
// M√©todos de b√∫squeda
- Por nombre completo
- Por n√∫mero de tel√©fono
- Por ID de paciente
- Por fecha de nacimiento
- Por fecha de √∫ltima visita
```

### 3. Actualizaci√≥n de Informaci√≥n M√©dica
```php
// Escenarios comunes
- Cambio de tel√©fono de contacto
- Actualizaci√≥n de alergias
- Modificaci√≥n de observaciones
- Actualizaci√≥n de motivo de consulta
- Correcci√≥n de datos personales
```

### 4. Consulta de Historial Completo
```php
// Informaci√≥n incluida
- Datos demogr√°ficos
- Historial de citas
- Tratamientos realizados
- Pagos y facturas
- Observaciones m√©dicas
- Estad√≠sticas de atenci√≥n
```

## üß™ Casos de Prueba

### Pruebas de Validaci√≥n
```php
// Test: Nombre v√°lido
$this->post('/api/pacientes', [
    'nombre_completo' => 'Mar√≠a Jos√© Garc√≠a',
    'telefono' => '+1234567890',
    'motivo_consulta' => 'Limpieza dental'
])->assertStatus(201);

// Test: Nombre inv√°lido con n√∫meros
$this->post('/api/pacientes', [
    'nombre_completo' => 'Mar√≠a123',
    'telefono' => '+1234567890',
    'motivo_consulta' => 'Limpieza dental'
])->assertStatus(422);

// Test: Tel√©fono inv√°lido
$this->post('/api/pacientes', [
    'nombre_completo' => 'Mar√≠a Garc√≠a',
    'telefono' => 'telefono-inv√°lido',
    'motivo_consulta' => 'Limpieza dental'
])->assertStatus(422);
```

### Pruebas de B√∫squeda
```php
// Test: B√∫squeda por nombre
$response = $this->get('/api/pacientes?search=Mar√≠a');
$response->assertStatus(200);
$response->assertJsonStructure(['data', 'pagination']);

// Test: Paginaci√≥n
$response = $this->get('/api/pacientes?page=2&per_page=10');
$response->assertStatus(200);
$response->assertJsonPath('pagination.current_page', 2);
```

### Pruebas de Actualizaci√≥n
```php
// Test: Actualizaci√≥n exitosa
$paciente = Paciente::factory()->create();
$response = $this->put("/api/pacientes/{$paciente->id}", [
    'telefono' => '+9876543210'
]);
$response->assertStatus(200);
$response->assertJsonPath('data.telefono', '+9876543210');

// Test: Paciente no encontrado
$response = $this->put('/api/pacientes/999999', [
    'telefono' => '+9876543210'
]);
$response->assertStatus(404);
```

## üìà M√©tricas y Rendimiento

### Tiempo de Respuesta T√≠pico
```php
// Operaciones comunes
'index' => '~120ms (15 registros)'
'store' => '~80ms'
'show' => '~60ms'
'update' => '~90ms'
'search' => '~150ms (con filtros)'
```

### Uso de Memoria
```php
// Por operaci√≥n
'index' => '~2MB (15 registros)'
'store' => '~512KB'
'show' => '~1MB (con relaciones)'
'update' => '~768KB'
```

### Optimizaciones Implementadas
```php
// T√©cnicas aplicadas
- √çndices en campos de b√∫squeda frecuente
- Paginaci√≥n para listas grandes
- Lazy loading de relaciones
- Cache de consultas frecuentes
- Compresi√≥n de respuestas JSON
```

## üö® Manejo de Errores

### Categor√≠as de Errores
1. **Errores de Validaci√≥n** (422)
   ```json
   {
     "success": false,
     "message": "Los datos proporcionados no son v√°lidos",
     "errors": {
       "campo": ["mensaje espec√≠fico del error"]
     }
   }
   ```

2. **Errores de No Encontrado** (404)
   ```json
   {
     "success": false,
     "message": "Paciente no encontrado",
     "error_code": "PATIENT_NOT_FOUND"
   }
   ```

3. **Errores de Duplicado** (409)
   ```json
   {
     "success": false,
     "message": "Ya existe un paciente con informaci√≥n similar",
     "similar_patient": { "id": 123, "nombre": "..." }
   }
   ```

4. **Errores del Servidor** (500)
   ```json
   {
     "success": false,
     "message": "Error interno del servidor",
     "error_id": "ERR_2025091015450001"
   }
   ```

## üîß Configuraci√≥n y Dependencias

### Variables de Entorno
```env
# Configuraci√≥n de pacientes
PATIENT_PAGINATION_DEFAULT=15
PATIENT_PAGINATION_MAX=100
PATIENT_SEARCH_MIN_LENGTH=2
PATIENT_AUDIT_ENABLED=true
```

### Base de Datos
```sql
-- √çndices para optimizaci√≥n
CREATE INDEX idx_pacientes_nombre ON pacientes(nombre_completo);
CREATE INDEX idx_pacientes_telefono ON pacientes(telefono);
CREATE INDEX idx_pacientes_fecha_nacimiento ON pacientes(fecha_nacimiento);
CREATE INDEX idx_pacientes_created_at ON pacientes(created_at);
```

### Middlewares Aplicados
```php
// Middleware stack
'web',           // Sesiones y CSRF
'auth',          // Autenticaci√≥n requerida
'throttle:60,1', // Rate limiting
'audit'          // Logging de auditor√≠a
```

## üîÆ Mejoras Futuras

### Funcionalidades Planificadas
```php
// Versi√≥n 2.2
- Importaci√≥n masiva desde CSV/Excel
- Exportaci√≥n de datos (PDF, Excel)
- Integraci√≥n con sistemas de seguros
- API REST completa para terceros
- B√∫squeda avanzada con filtros m√∫ltiples

// Versi√≥n 2.3
- Reconocimiento facial para identificaci√≥n
- Integraci√≥n con WhatsApp Business
- Recordatorios autom√°ticos de citas
- Portal del paciente (self-service)
- Integraci√≥n con historia cl√≠nica digital
```

### Optimizaciones T√©cnicas
```php
// Performance improvements
- Redis cache para b√∫squedas frecuentes
- Elasticsearch para b√∫squeda avanzada
- CDN para im√°genes de pacientes
- Database sharding para alta escala
- GraphQL API para consultas optimizadas
```

## üìö Referencias y Est√°ndares

### Regulaciones M√©dicas
- **HIPAA** (Health Insurance Portability and Accountability Act)
- **Ley de Protecci√≥n de Datos Personales**
- **Normas ISO 27001** para seguridad de informaci√≥n
- **HL7 FHIR** para interoperabilidad de datos m√©dicos

### Mejores Pr√°cticas
- **Domain-Driven Design** para modelado de pacientes
- **SOLID Principles** en arquitectura del controlador
- **Clean Code** para mantenibilidad del c√≥digo
- **Test-Driven Development** para confiabilidad

---

**Autor**: Sistema DentalSync  
**Fecha de creaci√≥n**: 10 de Septiembre 2025  
**Versi√≥n del documento**: 1.0  
**Estado**: ‚úÖ Completo y actualizado

> üìã **Nota**: Este controlador maneja informaci√≥n m√©dica sensible. Cualquier modificaci√≥n debe ser revisada por el equipo de seguridad y cumplir con las regulaciones de protecci√≥n de datos aplicables.
